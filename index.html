<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game</title>
    <style>
        #board{
            width: 100%;
            display: grid;
            grid-template-columns: repeat(3, auto);
            gap: 10px;
            /* column-gap: 0px; */
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <h1 id="timer">30</h1>
    <button id="create">Create</button>
    <button id="join">Join</button>
    <input id="username" placeholder="UserName" type="text" required>
    <input id="textGameId" placeholder="Game Id" type="text">
    <button onclick="copy()">ðŸ“‹</button>
    <div id="players"></div>
    <button disabled id="start">Start</button>
    <div id="board"></div>

    <script>
        let clientId = null;
        let gameId = null;
        let playerColor = null;
        let ballCount = 0;
        let clientsColorName = {};
        
        const ws = new WebSocket("ws://localhost:8080","echo-protocol")

        const buttonCreate = document.getElementById("create")
        const buttonJoin = document.getElementById("join")
        const inputGameId = document.getElementById("textGameId")
        const divPlayers = document.getElementById("players")
        const divBoard = document.getElementById("board")
        const buttonStart = document.getElementById("start")
        const textTimer = document.getElementById("timer")


        buttonCreate.addEventListener("click",e => {
            const payload = {
                "method": "create",
                "clientId": clientId
            }
            ws.send(JSON.stringify(payload))
            buttonStart.disabled = false
        })

        buttonJoin.addEventListener("click",e=>{

            if(gameId == null)
                gameId = inputGameId.value
            const payload = {
                "method": "join",
                "clientId": clientId,
                "gameId": gameId,
                "userName":document.getElementById("username").value
            }
            ws.send(JSON.stringify(payload))
            console.log("Join request sent to server")
        })


        buttonStart.addEventListener("click",e=>{
            if(gameId == null)
            {
                alert("Create a new game")
                return
            }
            const payload = {
                "method": "start",
                "gameId": gameId,
                "start": true
            }
            ws.send(JSON.stringify(payload))
        })

        ws.onmessage = message => {
            const response = JSON.parse(message.data);
            
            // connect
            if(response.method === "connect"){
                clientId = response.clientId;
                console.log("Client ID: " + clientId)
            }

            //create
            if(response.method === "create"){
                gameId = response.gameId.id;
                inputGameId.value = gameId;
                console.log("Game Created with id "+gameId + " with " + response.gameId.balls + " balls")
            }

            // join
            if(response.method === "join"){
                console.log("Join method received")
                const game = response.game

                divPlayers.innerHTML = "<h1>Players</h1>"
                let playerCount = 1
                game.clients.forEach(c => {
                    divPlayers.innerHTML += `<div style="color:${c.color}"><p>${c.userName} - Player${playerCount}</p></div>`
                    playerCount++;
                    clientsColorName[c.color] = c.userName
                    console.log(c.clientId)
                    if(c.clientId === clientId) 
                        playerColor = c.color;
                });

                while(ballCount < game.balls){
                    const b = document.createElement("button");
                    b.id = "ball" + ballCount
                    b.tag = ballCount
                    b.textContent = ballCount
                    b.style.width = "150px"
                    b.style.height = "150px"
                    b.style.backgroundColor = "gray"
                    b.addEventListener("click",e => {
                        console.log("Client Clicked the button")
                        const payload = {
                            "method": "play",
                            "clientId": clientId,
                            "gameId": gameId,
                            "ballId": b.tag,
                            "color": playerColor
                        }
                        ws.send(JSON.stringify(payload))
                    });
                    divBoard.append(b);
                    ballCount += 1
                }
            }

            // update
            if(response.method == "update"){
                const state = response.game.state;
                if(!response.game.state)
                    return
                textTimer.innerHTML = Math.round(response.game.timer);
                // console.log(`state: ${state}`)
                for(const b of Object.keys(state)){
                    const tempColor = state[b]
                    document.getElementById("ball" + b).style.backgroundColor = tempColor;
                }
            }

            if(response.method === "winner"){
                const ranks = response.ranking;
                divPlayers.innerHTML = `<h1>Score</h1>`
                for(const r of Object.keys(ranks)){
                    const username = clientsColorName[r];
                    divPlayers.innerHTML += `<div style="color:${r}"><p>${username} - ${ranks[r]}</p></div>`
                }
            }

        }
    </script>
    <script>
        function copy(){
            const inputGameId = document.getElementById("textGameId");
            inputGameId.select();
            inputGameId.setSelectionRange(0,99999);

            document.execCommand("copy");
        }
    </script>
</body>
</html>